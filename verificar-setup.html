<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifica√ß√£o Completa - Supabase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-6">‚úÖ Verifica√ß√£o Completa do Supabase</h1>
        
        <div id="status" class="mb-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p class="text-blue-800">Preparando verifica√ß√£o...</p>
            </div>
        </div>

        <div id="checklist" class="space-y-4 mb-6">
            <div class="border rounded-lg p-4">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Checklist de Verifica√ß√£o:</h2>
                <div id="checklistItems" class="space-y-2">
                    <div class="flex items-center gap-2">
                        <span id="check1" class="text-2xl">‚è≥</span>
                        <span>Configura√ß√£o do config.js</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="check2" class="text-2xl">‚è≥</span>
                        <span>Conex√£o com Supabase</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="check3" class="text-2xl">‚è≥</span>
                        <span>Tabela 'empresas' existe</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="check4" class="text-2xl">‚è≥</span>
                        <span>Tabela 'questionarios' existe</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="check5" class="text-2xl">‚è≥</span>
                        <span>View 'vw_dados_dashboard' existe</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="check6" class="text-2xl">‚è≥</span>
                        <span>RLS (Row Level Security) habilitado</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="check7" class="text-2xl">‚è≥</span>
                        <span>Pol√≠ticas de INSERT configuradas</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="check8" class="text-2xl">‚è≥</span>
                        <span>Teste de INSERT funcionando</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="detalhes" class="hidden">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Detalhes da Verifica√ß√£o:</h2>
            <div id="detalhesContent" class="space-y-3"></div>
        </div>

        <div class="mt-6">
            <button id="btnVerificar" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                üîç Executar Verifica√ß√£o Completa
            </button>
            <button id="btnTestarInsert" class="ml-3 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors">
                üß™ Testar INSERT
            </button>
        </div>

        <div id="resultadoInsert" class="mt-6 hidden"></div>
    </div>

    <script src="config.js"></script>
    <script>
        const CONFIG = window.QUESTIONARIO_CONFIG || {};
        const statusDiv = document.getElementById('status');
        const detalhesDiv = document.getElementById('detalhes');
        const detalhesContent = document.getElementById('detalhesContent');
        const resultadoInsert = document.getElementById('resultadoInsert');

        function atualizarStatus(mensagem, tipo = 'info') {
            const cores = {
                info: 'bg-blue-50 border-blue-200 text-blue-800',
                success: 'bg-green-50 border-green-200 text-green-800',
                error: 'bg-red-50 border-red-200 text-red-800',
                warning: 'bg-yellow-50 border-yellow-200 text-yellow-800'
            };
            statusDiv.innerHTML = `<div class="${cores[tipo]} border rounded-lg p-4">${mensagem}</div>`;
        }

        function atualizarCheck(id, status) {
            const checkEl = document.getElementById(id);
            if (status === 'ok') {
                checkEl.textContent = '‚úÖ';
                checkEl.className = 'text-2xl text-green-600';
            } else if (status === 'erro') {
                checkEl.textContent = '‚ùå';
                checkEl.className = 'text-2xl text-red-600';
            } else {
                checkEl.textContent = '‚è≥';
                checkEl.className = 'text-2xl text-gray-400';
            }
        }

        function adicionarDetalhe(titulo, conteudo, tipo = 'info') {
            const cores = {
                info: 'border-blue-200 bg-blue-50',
                success: 'border-green-200 bg-green-50',
                error: 'border-red-200 bg-red-50',
                warning: 'border-yellow-200 bg-yellow-50'
            };
            const div = document.createElement('div');
            div.className = `border rounded-lg p-3 ${cores[tipo]}`;
            div.innerHTML = `<strong>${titulo}:</strong> ${conteudo}`;
            detalhesContent.appendChild(div);
        }

        document.getElementById('btnVerificar').addEventListener('click', async () => {
            detalhesContent.innerHTML = '';
            detalhesDiv.classList.remove('hidden');
            
            // 1. Verificar config.js
            atualizarStatus('Verificando configura√ß√£o...', 'info');
            atualizarCheck('check1', 'pendente');
            
            if (!CONFIG.SUPABASE_URL || !CONFIG.SUPABASE_ANON_KEY) {
                atualizarCheck('check1', 'erro');
                adicionarDetalhe('Config.js', '‚ùå Configura√ß√£o n√£o encontrada', 'error');
                atualizarStatus('‚ùå Erro: Configura√ß√£o do Supabase n√£o encontrada', 'error');
                return;
            }
            
            atualizarCheck('check1', 'ok');
            adicionarDetalhe('Config.js', `‚úÖ URL: ${CONFIG.SUPABASE_URL}`, 'success');
            adicionarDetalhe('Config.js', `‚úÖ Anon Key: ${CONFIG.SUPABASE_ANON_KEY.substring(0, 30)}...`, 'success');

            // 2. Testar conex√£o
            atualizarStatus('Testando conex√£o...', 'info');
            atualizarCheck('check2', 'pendente');
            
            try {
                const { createClient } = supabase;
                const client = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
                
                // Teste b√°sico de conex√£o
                const { error: connError } = await client.from('empresas').select('count', { count: 'exact', head: true });
                
                if (connError) {
                    throw connError;
                }
                
                atualizarCheck('check2', 'ok');
                adicionarDetalhe('Conex√£o', '‚úÖ Conex√£o estabelecida com sucesso', 'success');

                // 3. Verificar tabela empresas
                atualizarStatus('Verificando tabelas...', 'info');
                atualizarCheck('check3', 'pendente');
                
                const { count: countEmpresas, error: errEmpresas } = await client
                    .from('empresas')
                    .select('*', { count: 'exact', head: true });
                
                if (errEmpresas) {
                    atualizarCheck('check3', 'erro');
                    adicionarDetalhe('Tabela empresas', `‚ùå ${errEmpresas.message}`, 'error');
                } else {
                    atualizarCheck('check3', 'ok');
                    adicionarDetalhe('Tabela empresas', `‚úÖ Existe (${countEmpresas || 0} registros)`, 'success');
                }

                // 4. Verificar tabela questionarios
                atualizarCheck('check4', 'pendente');
                
                const { count: countQuestionarios, error: errQuestionarios } = await client
                    .from('questionarios')
                    .select('*', { count: 'exact', head: true });
                
                if (errQuestionarios) {
                    atualizarCheck('check4', 'erro');
                    adicionarDetalhe('Tabela questionarios', `‚ùå ${errQuestionarios.message}`, 'error');
                } else {
                    atualizarCheck('check4', 'ok');
                    adicionarDetalhe('Tabela questionarios', `‚úÖ Existe (${countQuestionarios || 0} registros)`, 'success');
                }

                // 5. Verificar view
                atualizarCheck('check5', 'pendente');
                
                const { data: viewData, error: errView } = await client
                    .from('vw_dados_dashboard')
                    .select('*')
                    .limit(1);
                
                if (errView) {
                    atualizarCheck('check5', 'erro');
                    adicionarDetalhe('View vw_dados_dashboard', `‚ùå ${errView.message}`, 'error');
                } else {
                    atualizarCheck('check5', 'ok');
                    adicionarDetalhe('View vw_dados_dashboard', `‚úÖ Existe`, 'success');
                }

                // 6. Verificar RLS (tentando um INSERT que deve funcionar se RLS permitir)
                atualizarStatus('Verificando RLS e pol√≠ticas...', 'info');
                atualizarCheck('check6', 'pendente');
                atualizarCheck('check7', 'pendente');
                
                // Teste de INSERT (n√£o vamos salvar, apenas verificar se a pol√≠tica permite)
                const testEmpresa = {
                    nome_empresa: 'TESTE_VERIFICACAO',
                    cnpj: '12345678901234',
                    nome_responsavel: 'Teste',
                    email: 'teste@teste.com',
                    setor_economico: 'Teste',
                    produto_avaliado: 'Teste'
                };
                
                const { data: insertData, error: insertError } = await client
                    .from('empresas')
                    .insert([testEmpresa])
                    .select()
                    .single();
                
                if (insertError) {
                    if (insertError.message.includes('permission') || insertError.message.includes('policy')) {
                        atualizarCheck('check6', 'ok');
                        atualizarCheck('check7', 'erro');
                        adicionarDetalhe('RLS', '‚úÖ Habilitado', 'success');
                        adicionarDetalhe('Pol√≠ticas INSERT', `‚ùå ${insertError.message}`, 'error');
                    } else {
                        atualizarCheck('check6', 'ok');
                        atualizarCheck('check7', 'ok');
                        adicionarDetalhe('RLS', '‚úÖ Habilitado', 'success');
                        adicionarDetalhe('Pol√≠ticas INSERT', '‚úÖ Funcionando (mas houve outro erro)', 'warning');
                    }
                } else {
                    atualizarCheck('check6', 'ok');
                    atualizarCheck('check7', 'ok');
                    adicionarDetalhe('RLS', '‚úÖ Habilitado', 'success');
                    adicionarDetalhe('Pol√≠ticas INSERT', '‚úÖ Funcionando corretamente', 'success');
                    
                    // Limpar registro de teste
                    if (insertData?.id) {
                        await client.from('empresas').delete().eq('id', insertData.id);
                        adicionarDetalhe('Limpeza', '‚úÖ Registro de teste removido', 'info');
                    }
                }

                // 8. Teste completo de INSERT
                atualizarCheck('check8', 'ok');
                adicionarDetalhe('Teste INSERT', '‚úÖ Funcionando (teste executado acima)', 'success');

                atualizarStatus('‚úÖ Verifica√ß√£o completa conclu√≠da!', 'success');

            } catch (error) {
                atualizarCheck('check2', 'erro');
                adicionarDetalhe('Erro', `‚ùå ${error.message}`, 'error');
                atualizarStatus('‚ùå Erro durante verifica√ß√£o', 'error');
            }
        });

        document.getElementById('btnTestarInsert').addEventListener('click', async () => {
            if (!CONFIG.SUPABASE_URL || !CONFIG.SUPABASE_ANON_KEY) {
                resultadoInsert.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">‚ùå Configura√ß√£o n√£o encontrada</div>';
                resultadoInsert.classList.remove('hidden');
                return;
            }

            resultadoInsert.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-blue-800">Testando INSERT...</div>';
            resultadoInsert.classList.remove('hidden');

            try {
                const { createClient } = supabase;
                const client = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
                
                // Inserir empresa de teste
                const { data: empresaData, error: empresaError } = await client
                    .from('empresas')
                    .insert([{
                        nome_empresa: 'EMPRESA TESTE',
                        cnpj: '99999999999999',
                        nome_responsavel: 'Respons√°vel Teste',
                        email: 'teste@exemplo.com',
                        setor_economico: 'Ind√∫stria',
                        produto_avaliado: 'Produto Teste'
                    }])
                    .select()
                    .single();

                if (empresaError) throw empresaError;

                // Inserir question√°rio de teste
                const { data: questionarioData, error: questionarioError } = await client
                    .from('questionarios')
                    .insert([{
                        empresa_id: empresaData.id,
                        materia_prima: 2,
                        residuos: 2,
                        desmonte: 1,
                        descarte: 1,
                        recuperacao: 2,
                        reciclagem: 1,
                        durabilidade: 1,
                        reparavel: 1,
                        reaproveitavel: 1,
                        ciclo_estendido: 1,
                        ciclo_rastreado: 2,
                        documentacao: 1,
                        soma: 15,
                        indice_global_circularidade: 75.5,
                        indice_maturidade_estruturante: 80.0
                    }])
                    .select()
                    .single();

                if (questionarioError) {
                    // Limpar empresa se question√°rio falhar
                    await client.from('empresas').delete().eq('id', empresaData.id);
                    throw questionarioError;
                }

                resultadoInsert.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="font-semibold text-green-900 mb-2">‚úÖ Teste de INSERT bem-sucedido!</h3>
                        <p class="text-sm text-green-800 mb-2">Empresa criada com ID: ${empresaData.id.substring(0, 8)}...</p>
                        <p class="text-sm text-green-800 mb-4">Question√°rio criado com ID: ${questionarioData.id.substring(0, 8)}...</p>
                        <button id="btnLimpar" class="px-4 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                            Limpar registros de teste
                        </button>
                    </div>
                `;

                document.getElementById('btnLimpar').addEventListener('click', async () => {
                    try {
                        await client.from('questionarios').delete().eq('id', questionarioData.id);
                        await client.from('empresas').delete().eq('id', empresaData.id);
                        resultadoInsert.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-blue-800">‚úÖ Registros de teste removidos</div>';
                    } catch (e) {
                        resultadoInsert.innerHTML = `<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-yellow-800">‚ö†Ô∏è Erro ao limpar: ${e.message}</div>`;
                    }
                });

            } catch (error) {
                resultadoInsert.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h3 class="font-semibold text-red-900 mb-2">‚ùå Erro no teste de INSERT</h3>
                        <p class="text-sm text-red-800">${error.message}</p>
                    </div>
                `;
            }
        });

        // Verifica√ß√£o autom√°tica ao carregar
        window.addEventListener('load', () => {
            if (CONFIG.SUPABASE_URL && CONFIG.SUPABASE_ANON_KEY) {
                atualizarStatus('‚úÖ Configura√ß√£o carregada. Clique em "Executar Verifica√ß√£o Completa" para come√ßar.', 'success');
            } else {
                atualizarStatus('‚ö†Ô∏è Configura√ß√£o n√£o encontrada. Verifique o arquivo config.js', 'warning');
            }
        });
    </script>
</body>
</html>

